# ==============================================================================
# Rocky Linux 9 Kickstart - Infra Node (Generated by Ansible)
# ==============================================================================
# Ansible managed

# ------------------------------------------------------------------
# Installation mode & source
# ------------------------------------------------------------------
text
reboot

# IMPORTANT:
# This URL must point to the ROOT containing .treeinfo
url --url="http://50.50.50.1/rocky9"

lang en_US.UTF-8
keyboard us
timezone Asia/Jerusalem --utc

# ------------------------------------------------------------------
# Network (PXE → install → persistent)
# ------------------------------------------------------------------
network --bootproto=dhcp --device=link --activate --onboot=on

# ------------------------------------------------------------------
# Security
# ------------------------------------------------------------------
rootpw --plaintext P@ssw0rd

# Choose ONE policy (infra default = secure)
selinux --enforcing
firewall --enabled --ssh
# --- OR ---
# selinux --disabled
# firewall --disabled

# ------------------------------------------------------------------
# Disk handling (HARD RESET)
# ------------------------------------------------------------------
ignoredisk --only-use=sda
zerombr
clearpart --all --initlabel --drives=sda --disklabel=gpt

# ------------------------------------------------------------------
# EFI + /boot
# ------------------------------------------------------------------
part /boot/efi --fstype=efi --size=600 --ondisk=sda
part /boot     --fstype=xfs --size=1024 --ondisk=sda

# ------------------------------------------------------------------
# LVM layout
# ------------------------------------------------------------------
part pv.01 --fstype=lvmpv --ondisk=sda --size=1 --grow
volgroup vg_system pv.01

logvol swap --vgname=vg_system --name=swap --fstype=swap --size=4096
logvol /    --vgname=vg_system --name=root --fstype=xfs  --size=1 --grow

# ------------------------------------------------------------------
# Package set (minimal + Ansible support)
# ------------------------------------------------------------------
%packages
@^minimal-environment
python3
python3-dnf
curl
wget
vim
tmux
bash-completion
rsync
lsof
which
%end

# ------------------------------------------------------------------
# PRE: wipe residual metadata (CRITICAL)
# ------------------------------------------------------------------
%pre --log=/tmp/ks-pre.log
wipefs -a /dev/sda || true
%end

# ------------------------------------------------------------------
# POST: Infra bootstrap
# ------------------------------------------------------------------
%post --log=/root/ks-post.log

# --------------------------------------------------
# Create Ansible management user (NO auto home)
# --------------------------------------------------
useradd -M -d /var/lib/ansible -s /bin/bash ansible
echo "ansible:P@ssw0rd" | chpasswd

echo "ansible ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/ansible
chmod 0440 /etc/sudoers.d/ansible

# --------------------------------------------------
# Create and secure home manually
# --------------------------------------------------
mkdir -p /var/lib/ansible/.ssh
chown -R ansible:ansible /var/lib/ansible
chmod 0700 /var/lib/ansible
chmod 0700 /var/lib/ansible/.ssh

# --------------------------------------------------
# Inject SSH key
# --------------------------------------------------
cat << 'EOF' > /var/lib/ansible/.ssh/authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC4pA1l1CC3yUcJAFZKsVswNPyrOOpbxf5U4tOLkrQ/g3M5Y/CpdowqMeTspuklZWp/SU7usGUXRfNA0Q0v93MyVyBmUNBi9djC8rTJuN1sBIMK0WFxBySKzZnB+BukNRJiqd5FqmvZ8L5MU83MGVbGgseJHP0Ui91+qYdn/h2vUnwfmT0YXe+zBIPWuIyWVUVGme3rkCHxPd7BD6xDd4ZrexRDLPZpitO9/d2Sr8k7fcz9VllxancWOzRjsc6E4rfpaQGttgXUqcz35I6dGB8wBWCAw0ZAdz+kz7mCLblIKXpLaQFbIaXwDT9H8z29jRTqBylUq7yrjEjf4yBpwNoSCs4aKZ798Flf+ioIdELrRxWEzXS8lvD5cf5/vzydvVVaD2r0nrzPCOltM4a7/WfEzKCJTHbyPkNkll67Tb47cYae/at2eoM7MKvmi+hi3zKuDkctrjT5GEOg16TtxMXL4JnDoifxeFNQpEYee3ojPUcCVPugPy33wTScUt8PtqfdzrHS6cBL7SYiVjaazHGjxPcvY2DgYZE6HPBccJgFhvU2QUcAnID1NU0uq9CTgXUU7EdpCraiNXd2pmqCII/INmPtMk6p0/3N4h37oZ7CzoQ3WPG6dRPDxmoArJGWjkpMD88L3+WZIYgpLa6FxlN196ozqU3yMfCjvYJjkD6uqQ== root@Slurm-Infra
EOF

chmod 0600 /var/lib/ansible/.ssh/authorized_keys
chown ansible:ansible /var/lib/ansible/.ssh/authorized_keys

# --------------------------------------------------
# SSH hardening
# --------------------------------------------------
sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
sed -i 's/^PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config

systemctl enable sshd

# --------------------------------------------------
# Branding
# --------------------------------------------------
echo "Provisioned via iPXE + Infra Kickstart" > /etc/motd

%end

